<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
    <style>
      * {
        padding: 0;
        margin: 0;
      }

      body,
      html,
      #map {
        height: 100%;
      }

      .leaflet-marker-pane > * {
        transition: transform 6s linear;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      const tileLayer = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

      var map = L.map('map', {
        center: [48.2916063, 25.9345009],
        zoom: 13
      });

      L.tileLayer(tileLayer).addTo(map);

      function safeJSONParse(json) {
        try {
          return JSON.parse(json);
        } catch (e) {
          return null;
        }
      }

      class EventStreamClient {
        constructor(endpoint) {
          this.endpoint = endpoint;
          this.source = new EventSource(endpoint);
          this.source.onopen = event => console.log('open', event);
          this.source.onerror = event => console.log('error', event);
        }

        on(event, callback) {
          this.source.addEventListener(event, event =>
            callback(safeJSONParse(event.data), event)
          );
          return this;
        }

        receive(callback) {
          this.on('message', callback);
          return this;
        }
      }

      const stream = new EventStreamClient('/events');

      const markers = new Map();

      function renderSVG({
        speed,
        stroke = 'gray',
        fill = 'white',
        text = 'A',
        angle
      }) {
        const arrow = `
          <polygon
              points="55 20 45 25 55 0 65 25"
              stroke="${stroke}" fill="${fill}" stroke-width="2"
              transform="rotate(${angle},55,40)"/>
          `;
        const svg = `
          <svg version="1.1" baseProfile="full"   xmlns="http://www.w3.org/2000/svg">
            ${speed > 0 ? arrow : ''}
            <circle cx="55" cy="40" r="15" stroke="${stroke}" fill="${fill}" stroke-width="2"/>
            <text x="55" y="45" text-anchor="middle" font-size="15px" stroke="black" fill="black">${text}</text>
          </svg>
        `;

        return `data:image/svg+xml;base64,${btoa(svg)}`;
      }

      stream.receive((data, event) => {
        console.log('receive data:', event);
        data.forEach(tracker => {
          if (markers.has(tracker.id)) {
            return markers
              .get(tracker.id)
              .setLatLng([tracker.latitude, tracker.longitude])
              .setIcon(
                L.icon({
                  iconUrl: renderSVG({
                    speed: tracker.speed,
                    angle: tracker.direction
                  }),
                  iconAnchor: [55, 40]
                })
              );
          }

          const marker = L.marker([tracker.latitude, tracker.longitude], {
            icon: L.icon({
              iconUrl: renderSVG({
                speed: tracker.speed,
                angle: tracker.direction
              }),
              iconAnchor: [55, 40]
            })
          }).addTo(map);

          markers.set(tracker.id, marker);
        });
      });
    </script>
  </body>
</html>
